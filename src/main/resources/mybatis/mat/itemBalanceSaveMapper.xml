<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seohan.erp.mat.mapper.">

	<!-- 코드 관련 쿼리 -->
	<select id="getOldBalanceByDate" resultType="com.seohan.erp.mat.Domain.ItemBalanceHisOld" parameterType="com.seohan.erp.mat.Dto.ItemBalanceSaveQuery">
		SELECT  #{nowdate} GDATE, #{savingtime} GTIME, BL.WARHS, BL.ITMNO, BL.LOCAT, BL.LOTNO, INDATE, INTIME, BL.JQTY QTY,
		coalesce(CASE WHEN GUBN = 'B' THEN FDANGA  ELSE PURDANGA END, 0) PRICE, 'O' STS
		FROM (
		select * From SMLIB.ITMBLPFSUB A
		where  WARHS in ('AB', 'BB', 'GB') AND INTIME < #{olddate}
		) BL
		EXCEPTION JOIN (
		SELECT  DISTINCT A.WARHS, A.ITMNO FROM 						SMLIB.TRANSPF A
		WHERE A.TRSDT >= #{olddate}  AND WARHS in ('AB', 'BB', 'GB') AND QUNTY <> 0
		GROUP BY  A.WARHS, A.ITMNO
		) A ON A.WARHS = BL.WARHS AND  BL.ITMNO = A.ITMNO
		LEFT OUTER JOIN SMLIB.SAGBMST SG ON BL.ITMNO = SG.GITEM
		LEFT OUTER JOIN (SELECT ITMNO, ROUND(MAX(DANGA),2) FDANGA FROM SMLIB.PURCTPF WHERE STRDT ='00000000' AND GAE in ('NC','B4', 'C4') GROUP BY ITMNO) F ON BL.ITMNO = F.ITMNO
		LEFT OUTER JOIN (SELECT ITMNO, ROUND(MAX(DANGA),2) PURDANGA FROM SMLIB.PURCTPF WHERE STRDT = '00000000' AND UEXC = 'W'  AND GAE IN ('B4', 'C4') GROUP BY ITMNO) PUR ON BL.ITMNO = PUR.ITMNO
		Union All
		SELECT DISTINCT #{nowdate} GDATE, #{savingtime} GTIME, BL.WARHS, BL.ITMNO,  LOCAT, BL.LOTNO,  INDATE,  INTIME, BL.ONHND QTY, coalesce(DANGA,0) PRICE, 'O' FROM (
		SELECT LEFT(WARHS,1) FACT, WARHS,  ITMNO, LOTNO, LOCAT, QTY ONHND, INDATE, INTIME FROM SMLIB.ITMBLPFSUB
		where  JQTY <> 0 AND RIGHT(TRIM(WARHS),1)='Q' AND LENGTH(TRIM(WARHS)) = 2 and indate < #{olddate}
		) BL
		EXCEPTION JOIN (
		SELECT  DISTINCT A.WARHS, A.ITMNO FROM SMLIB.TRANSPF A
		INNER JOIN SALIB.ACODERP B ON A.WARHS = B.ASGUB AND B.ADGUB = 'PJ' AND AREF1 = 'SHN' AND B.ASGUB != 'F'
		WHERE A.TRSDT >= #{olddate} AND RIGHT(TRIM(A.WARHS), 1) = 'Q' AND LEFT(WARHS,1) NOT IN ('D', 'F') AND A.QUNTY > 0
		GROUP BY  A.WARHS, A.ITMNO
		) A ON A.WARHS = BL.WARHS AND  BL.ITMNO = A.ITMNO
		LEFT OUTER JOIN (
		SELECT DISTINCT ITM.ITMNO, coalesce(C.AFILL, ROUND(DANGA,2), 0) DANGA FROM SMLIB.ITMSTPF ITM
		LEFT OUTER JOIN SMLIB.DANGA_LIST A ON ITM.ITMNO= A.ITMNO AND GAE IN ('FA', 'AD', 'C4', 'B4' )
		LEFT OUTER JOIN SALIB.ACODERP C ON C.ADGUB = 'PC' AND ITM.PMJGB = C.ASGUB AND C.AFILL > '0'
		) PUR ON BL.ITMNO = PUR.ITMNO
		Where BL.ONHND <> 0
		Union All
		SELECT DISTINCT #{nowdate} GDATE, #{savingtime} GTIME, BL.WARHS, BL.ITMNO, BL.LOCAT, BL.LOTNO, INDATE, INTIME, BL.JQTY QTY, coalesce(DANGA,0) PRICE, 'O' ONMNY FROM (
		select * From SMLIB.ITMBLPFSUB
		where JQTY <> 0 AND RIGHT(TRIM(WARHS), 1) IN ('A','W') AND WARHS NOT IN ('A','FA','HA') AND LOCAT <> 'SY' AND LENGTH(TRIM(WARHS)) = 2  and indate <#{olddate}
		Union
		select * From SMLIB.ITMBLPFSUB where  JQTY <> 0 AND WARHS IN ('FA') AND LENGTH(TRIM(WARHS)) = 2 and indate <#{olddate}
		) BL
		LEFT OUTER JOIN (
		SELECT DISTINCT ITM.ITMNO, coalesce(C.AFILL, ROUND(DANGA,2), 0) DANGA FROM SMLIB.ITMSTPF ITM
		LEFT OUTER JOIN SMLIB.DANGA_LIST A ON ITM.ITMNO= A.ITMNO AND GAE IN ('FA', 'AD', 'C4', 'B4' )
		LEFT OUTER JOIN SALIB.ACODERP C ON C.ADGUB = 'PC' AND ITM.PMJGB = C.ASGUB AND C.AFILL > '0'
		) PUR ON BL.ITMNO = PUR.ITMNO
		EXCEPTION JOIN (
		SELECT  DISTINCT A.WARHS , A.ITMNO FROM SMLIB.TRANSPF A
		WHERE A.TRSDT >= #{olddate}  AND RIGHT(TRIM(A.WARHS), 1) = 'A' AND LENGTH(TRIM(WARHS)) = 2 AND A.QUNTY > 0
		) A ON A.WARHS = BL.WARHS AND  A.ITMNO = BL.ITMNO
		ORDER BY WARHS, ITMNO
	</select>

</mapper>